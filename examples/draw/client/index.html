<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Draw With Friends</title>
    <script src="../../../packages/jiber-client/dist/jiber-client.bundle.js">
    </script>
  </head>
  <body style="background-color: grey; padding: 0; margin: 0;">
    <canvas id="line-canvas" width="500" height="500"></canvas>

    <script>

      //////////////////////////////////////////////////////////////////////////
      // INIT: create a room to sync our masterful drawing
      //////////////////////////////////////////////////////////////////////////
      const scale = 10                                                          // each 'pixel' is actually a 10px by 10px square
      const store = $jiber.createStore({url: 'localhost'})                      // $jiber is a global variable when jiber-client.bundle.js is loaded
      const room = store.createRoom('room1')
      const canvas = document.getElementById('line-canvas')
      const ctx = canvas.getContext('2d')


      //////////////////////////////////////////////////////////////////////////
      // RENDER LOOP: draw the state onto the canvas every frame
      //////////////////////////////////////////////////////////////////////////
      function render () {
        const state = room.getState()
        const confirmedState = room.getConfirmedState()
        console.log({state, confirmedState})
        clearCanvas()
        drawPixels(state)
      }

      function clearCanvas () {
        ctx.fillStyle = 'white'
        ctx.fillRect(0, 0, canvas.width, canvas.height)
      }

      function drawPixels (state) {
        Object.keys(state).forEach(point => {
          const [x, y] = point.split(',')
          const color = state[point]
          ctx.fillStyle = color
          ctx.fillRect(x * scale, y * scale, scale, scale)
        })
      }

      render()
      store.subscribe(render)

      //////////////////////////////////////////////////////////////////////////
      // I/O: color in pixels when a user clicks (or taps) and drags
      //////////////////////////////////////////////////////////////////////////
      function setPixel (e, color) {
        const x = Math.floor(e.clientX / scale)
        const y = Math.floor(e.clientY / scale)
        const path = `${x},${y}`
        const state = room.getState()
        if (state[path] === color) return                                       // avoid dispatching redundant actions
        room.set(path, color)
      }

      function randomColor () {
        const hexChars = '0123456789ABCDEF'
        let color = '#'
        for (let i = 0; i < 6; i++) {
          const index = Math.floor(Math.random() * hexChars.length)
          color += hexChars.charAt(index)
        }
        return color
      }

      canvas.onmousedown = (e) => {
        const color = randomColor()
        setPixel(e, color)
        canvas.onmousemove = (e) => setPixel(e, color)
        window.onmouseup = (e) => canvas.onmousemove = undefined
      }

    </script>
  </body>
</html>
