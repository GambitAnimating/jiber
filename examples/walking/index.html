<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Walking Dots</title>
    <script src="../../packages/jiber-client/dist/jiber-client.bundle.js">
    </script>
  </head>
  <body style="background-color: grey; padding: 0; margin: 0;">
    <canvas id="walking-canvas" width="500" height="500"></canvas>

    <script>

      //////////////////////////////////////////////////////////////////////////
      // INIT
      //////////////////////////////////////////////////////////////////////////

      // Our app logic
      const players = (state = {}, action) => {
        switch (action.type) {
          case 'jiber/JOIN_ROOM':
            return {...state, [action.$u]: {pos: {x: 0, y: 0}}}
          case 'jiber/LEAVE_ROOM':
            return {...state, [action.$u]: undefined}
          case 'WALK_TO':
            const player = {...state[action.$u]}
            if (player.targetPos) player.pos = player.targetPos
            player.targetPos = {x: action.x, y: action.y}
            return {...state, [action.$u]: player}
          default:
            return state
        }
      }

      const timeMs = (state = 0, action) => {
        return action.$t || state
      }

      const reducer = $jiber.combineReducers({
        players,
        timeMs
      })

      const speed = 1
      const interval = 1000 / 60  // 60 fps
      const physics = (state, timeMs) => {
        while (timeMs - state.timeMs > interval) {
          console.log('loop', state.timeMs)
          state.timeMs += interval
          Object.keys(state.players).forEach(playerId => {
            const player = state.players[playerId]
            if (!player.targetPos) return

            const distX = player.pos.x - player.targetPos.x
            const distY = player.pos.y - player.targetPos.y
            const dist = Math.sqrt(Math.pow(distX, 2) + Math.pow(distY, 2))
            if (dist < speed) {
              player.pos = player.targetPos
              player.targetPos = undefined
              return
            }

            const angle = Math.atan2(distX, distY)
            const moveX = Math.cos(angle) * speed
            const moveY = Math.sin(angle) * speed
            player.pos.x += moveX
            player.pos.y += moveY
          })
        }
      }

      const actionCreators = {
        walkTo: (x, y) => ({type: 'WALK_TO', x, y})
      }

      // TODO: host a demo server
      const url = 'localhost'

      // create a room to sync our masterful drawing
      const store = $jiber.createStore({url, reducer, actionCreators})
      const room = store.createRoom('walking')

      // set up our canvas to draw on
      const canvas = document.getElementById('walking-canvas')
      const ctx = canvas.getContext('2d')


      //////////////////////////////////////////////////////////////////////////
      // RENDER: draw the state onto the canvas when our data changes
      //////////////////////////////////////////////////////////////////////////
      function render () {
        const state = room.getState()
        const nowState = physics(state, new Date().getTime())
        clearCanvas()
        draw(nowState)
        window.requestAnimationFrame(render)
      }

      function clearCanvas () {
        ctx.fillStyle = 'white'
        ctx.fillRect(0, 0, canvas.width, canvas.height)
      }

      function draw (state) {
        ctx.fillStyle = 'green'
        ctx.lineWidth = 1
        ctx.strokeStyle = 'black'
        Object.keys(state.players).forEach(playerId => {
          const player = state.players[playerId]
          ctx.beginPath()
          ctx.arc(player.pos.x, player.pos.y, 5, 0, 2 * Math.PI, false)
          ctx.fill()
          ctx.stroke()
        })
      }

      render()



      //////////////////////////////////////////////////////////////////////////
      // I/O
      //////////////////////////////////////////////////////////////////////////
      canvas.onmousedown = (e) => {
        room.walkTo(e.clientX, e.clientY)
      }

    </script>
  </body>
</html>
