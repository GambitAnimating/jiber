{
  "/^game.*/": {
    "join": "room.members.length < 10",
    "transactions": {
      "DRAW_CARD": {
        ".if": "turn === auth.uid && phase === 'DRAW_CARD'",
        ".dispatch": [
          "pop('members.${auth.uid}.deck', 'pendingCard')",
          "push('members.${auth.uid}.hand', pendingCard)",
          "set('phase', 'PLAY_CARD')"
        ]
      },
      "PLAY_CARD": {
        ".if": "turn === auth.uid && phase === 'PLAY_CARD'",
        ".dispatch": [
          "splice('members.${auth.uid}.hand', 'pendingCard', action.cardIndex, 1)",
          "push('members.${auth.uid}.table.${action.stackIndex}', pendingCard)",
          "set('phase', 'BATTLE')"
        ]
      },
      "BATTLE": {
        ".if": "turn == auth.uid && phase === 'BATTLE'",
        ".dispatch": [
          "set('me', members[auth.uid])",
          "set('them', members[action.targetUid])",
          "set('myStack', me.table[action.stackIndex])",
          "set('theirStack', them.table[action.stackIndex])",
          "set('myCard', myStack[myStack.length - 1])",
          "set('theirCard', theirStack[theirStack.length - 1])",
          "subtract('theirCard.hp', myCard.attack)"
        ]
      }
    },
    "state": {
      "turn": {
        ".read": true
      },
      "phase": {
        ".read": true
      },
      "members": {
        "${uid}": {
          "hand": [{ ".read": true, ".type": "string" }],
          "deck": [{ ".type": "string" }],
          "table": {
            ".read": true
          }
        }
      }
    }
  }
}
