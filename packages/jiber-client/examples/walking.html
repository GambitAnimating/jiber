<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Walking Dots</title>
    <script src="https://unpkg.com/jiber-client"></script>
  </head>
  <body style="background-color: grey; padding: 0; margin: 0;">
    <canvas id="walking-canvas" width="500" height="500"></canvas>

    <script>

      //////////////////////////////////////////////////////////////////////////
      // REDUCER
      //////////////////////////////////////////////////////////////////////////
      const speed = 0.3 // pixels per millisecond

      // Our app logic
      const player = (state, action) => {
        if (!state) {
          state = {
            posX: 250,
            posY: 250,
            color: randomColor()
          }
        }
        switch (action.type) {
          case 'jiber/LEAVE_ROOM':
            return undefined
          case 'COLOR':
            return {...state, color: action.color}
          case 'WALK_TO':
            return {...state, targetX: action.x, targetY: action.y}
          default:
            return state
        }
      }

      const players = (state, action) => {
        if (!action.$userId) return state
        const playerState = state[action.$userId]
        const newPlayerState = player(playerState, action)
        if (newPlayerState) {
          return {...state, [action.$userId]: newPlayerState}
        } else {
          state = {...state}
          delete state[action.$userId]
          return state
        }
      }

      const reducer = (pastState, action) => {
        if (!pastState) {
          pastState = {
            timeMs: new Date().getTime(),
            players: {}
          }
        }

        const currentState = physics(pastState, action.$timeMs)

        return {
          ...currentState,
          players: players(currentState.players, action)
        }
      }

      const physics = (state, timeMs) => {
        const elapsed = timeMs - state.timeMs
        state.timeMs = timeMs

        Object.keys(state.players).forEach(playerId => {
          const player = state.players[playerId]

          if (player.targetX === undefined) return

          const distX = player.targetX - player.posX
          const distY = player.targetY - player.posY
          const dist = Math.sqrt((distX * distX) + (distY * distY))
          const angle = Math.atan2(distY, distX)
          const moveX = Math.cos(angle) * speed * elapsed
          const moveY = Math.sin(angle) * speed * elapsed
          const move = speed * elapsed

          if (move > dist) {
            player.posX = player.targetX
            player.posY = player.targetY
            player.targetX = undefined
            player.targetY = undefined
          } else {
            player.posX += moveX
            player.posY += moveY
          }
        })

        return state
      }


      //////////////////////////////////////////////////////////////////////////
      // INIT
      //////////////////////////////////////////////////////////////////////////
      const actionCreators = {
        walkTo: (x, y) => ({type: 'WALK_TO', x, y}),
        setMyColor: (color) => ({type: 'COLOR', color})
      }

      // TODO: host a demo server
      const url = 'ws://localhost'

      // create a room to sync our masterful drawing
      const room = $jiber
        .createStore({url, reducer, actionCreators})
        .createRoom('walking')
      let gameState = room.getState()
      room.subscribe(state => gameState = state)

      // set up our canvas to draw on
      const canvas = document.getElementById('walking-canvas')
      const ctx = canvas.getContext('2d')


      //////////////////////////////////////////////////////////////////////////
      // RENDER: draw the state onto the canvas when our data changes
      //////////////////////////////////////////////////////////////////////////
      const render = () => {
        clearCanvas()
        gameState = physics(gameState, new Date().getTime())
        draw(gameState)
        window.requestAnimationFrame(render)
      }

      const clearCanvas = () => {
        ctx.fillStyle = 'white'
        ctx.fillRect(0, 0, canvas.width, canvas.height)
      }

      const draw = (state) => {
        ctx.lineWidth = 1
        ctx.strokeStyle = 'black'
        Object.keys(state.players).forEach(playerId => {
          const player = state.players[playerId]
          ctx.fillStyle = player.color
          ctx.beginPath()
          ctx.arc(player.posX, player.posY, 5, 0, 2 * Math.PI, false)
          ctx.fill()
          ctx.stroke()
        })
      }

      render()


      //////////////////////////////////////////////////////////////////////////
      // I/O
      //////////////////////////////////////////////////////////////////////////
      canvas.onmousedown = (e) => {
        room.walkTo(e.clientX, e.clientY)
      }

      const randomColor = () => {
        const hexChars = '0123456789ABCDEF'
        let color = '#'
        for (let i = 0; i < 6; i++) {
          const index = Math.floor(Math.random() * hexChars.length)
          color += hexChars.charAt(index)
        }
        return color
      }

      room.setMyColor(randomColor())

    </script>
  </body>
</html>
